<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°ç‹¬</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* æ£‹ç›˜æ ·å¼ */
        .sudoku-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            width: 340px;
            height: 340px;
            margin: 20px auto;
            background: #333; /* è¾¹æ¡†é¢œè‰² */
            border: 2px solid #333;
            gap: 1px;
        }
        .cell {
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        /* å®«æ ¼åŠ ç²—è¾¹æ¡† (3x3) */
        .cell:nth-child(3n) { border-right: 2px solid #333; }
        .cell:nth-child(9n) { border-right: none; } /* æœ€å³ä¾§ä¸éœ€è¦ */
        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #333;
        }

        /* çŠ¶æ€æ ·å¼ */
        .cell.fixed { font-weight: bold; color: #000; background: #f5f5f5; } /* é¢˜ç›®æ•°å­— */
        .cell.user-input { color: var(--wechat-green); } /* ç”¨æˆ·å¡«å†™çš„ */
        .cell.solved { color: #1aad19; font-weight: bold; } /* æ±‚è§£å™¨å¡«å…¥çš„ */
        .cell.selected { background: #e6f7ff; } /* é€‰ä¸­æ€ */
        .cell.error { background: #ffcccc; } /* é”™è¯¯æç¤º */

        /* åº•éƒ¨æ•°å­—é”®ç›˜ (ä»¿å¾®ä¿¡ ActionSheet) */
        .numpad-overlay {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; z-index: 100;
            align-items: flex-end;
        }
        .numpad-overlay.show { display: flex; }
        .numpad {
            width: 100%; background: #f7f7f7;
            border-radius: 12px 12px 0 0;
            padding: 20px; box-sizing: border-box;
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
            animation: slideUp 0.2s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .num-btn {
            height: 50px; background: #fff; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .num-btn:active { background: #e0e0e0; }
        .num-btn.clear { color: #fa5151; font-size: 16px; }
        .num-btn.close { grid-column: span 5; margin-top: 10px; font-size: 16px; background: transparent; box-shadow: none; }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .controls {
            display: flex; justify-content: space-between; padding: 0 20px; margin-bottom: 10px;
        }
        select {
            padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; font-size: 14px;
        }
        
        .mode-switch {
            display: flex; justify-content: center; margin-bottom: 15px;
        }
        .mode-btn {
            padding: 6px 16px; border: 1px solid var(--wechat-green); 
            color: var(--wechat-green); background: white;
            font-size: 14px; cursor: pointer;
        }
        .mode-btn:first-child { border-radius: 4px 0 0 4px; border-right: none; }
        .mode-btn:last-child { border-radius: 0 4px 4px 0; }
        .mode-btn.active { background: var(--wechat-green); color: white; }

    </style>
</head>
<body>
    <div class="navbar">
        <a class="nav-left" href="../index.html"><i class="icon-back"></i></a>
        <div class="nav-title">æ•°ç‹¬</div>
    </div>

    <div class="page-content">
        <!-- æ¨¡å¼åˆ‡æ¢ -->
        <div class="mode-switch">
            <div class="mode-btn active" id="modeGame" onclick="app.setMode('game')">é—¯å…³æ¨¡å¼</div>
            <div class="mode-btn" id="modeSolver" onclick="app.setMode('solver')">æ±‚è§£å™¨(è‡ªå¡«)</div>
        </div>

        <!-- æ¸¸æˆæ§åˆ¶æ  -->
        <div class="controls" id="gameControls">
            <select id="difficulty" onchange="app.newGame()">
                <option value="30">ç®€å•</option>
                <option value="40">ä¸­ç­‰</option>
                <option value="50">å›°éš¾</option>
            </select>
            <div class="info-text" style="margin:0">å‰©ä½™: <span id="remain">0</span></div>
        </div>

        <!-- æ±‚è§£å™¨æ§åˆ¶æ  -->
        <div class="controls" id="solverControls" style="display:none; justify-content: center;">
            <div class="info-text" style="margin:0; font-size: 13px; color: #888;">è¾“å…¥é¢˜ç›®æ•°å­—ï¼Œç‚¹å‡»â€œè‡ªåŠ¨æ±‚è§£â€</div>
        </div>

        <div id="board" class="sudoku-board"></div>

        <div class="btn-group">
            <button class="btn" id="mainBtn" onclick="app.handleMainBtn()">éªŒç®—</button>
            <button class="btn btn-sec" onclick="app.resetBoard()">æ¸…ç©º/é‡ç½®</button>
        </div>
    </div>

    <!-- åº•éƒ¨é”®ç›˜ -->
    <div class="numpad-overlay" id="numpadOverlay" onclick="app.closePad(event)">
        <div class="numpad">
            <div class="num-btn" onclick="app.fill(1)">1</div>
            <div class="num-btn" onclick="app.fill(2)">2</div>
            <div class="num-btn" onclick="app.fill(3)">3</div>
            <div class="num-btn" onclick="app.fill(4)">4</div>
            <div class="num-btn" onclick="app.fill(5)">5</div>
            <div class="num-btn" onclick="app.fill(6)">6</div>
            <div class="num-btn" onclick="app.fill(7)">7</div>
            <div class="num-btn" onclick="app.fill(8)">8</div>
            <div class="num-btn" onclick="app.fill(9)">9</div>
            <div class="num-btn clear" onclick="app.fill(null)">æ¸…é™¤</div>
            <div class="num-btn close" onclick="app.closePad(null, true)">å…³é—­é”®ç›˜</div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        class SudokuApp {
            constructor() {
                this.mode = 'game'; // 'game' or 'solver'
                this.selectedCell = null; // {index, el}
                this.boardData = Array(81).fill(null); // å½“å‰ç›˜é¢æ•°æ®
                this.fixedMask = Array(81).fill(false); // é¢˜ç›®é”å®šæ©ç 
                this.initUI();
                this.newGame();
            }

            initUI() {
                const board = document.getElementById('board');
                board.innerHTML = '';
                for (let i = 0; i < 81; i++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.index = i;
                    cell.onclick = (e) => this.onCellClick(i, cell);
                    board.appendChild(cell);
                }
            }

            // åˆ‡æ¢æ¨¡å¼
            setMode(mode) {
                this.mode = mode;
                document.getElementById('modeGame').className = mode === 'game' ? 'mode-btn active' : 'mode-btn';
                document.getElementById('modeSolver').className = mode === 'solver' ? 'mode-btn active' : 'mode-btn';
                
                document.getElementById('gameControls').style.display = mode === 'game' ? 'flex' : 'none';
                document.getElementById('solverControls').style.display = mode === 'solver' ? 'flex' : 'none';
                
                const mainBtn = document.getElementById('mainBtn');
                if(mode === 'game') {
                    mainBtn.innerText = 'éªŒç®—';
                    mainBtn.onclick = () => this.checkGame();
                    this.newGame();
                } else {
                    mainBtn.innerText = 'è‡ªåŠ¨æ±‚è§£';
                    mainBtn.onclick = () => this.solveUserBoard();
                    this.clearBoard();
                }
            }

            // --- æ¸¸æˆæ¨¡å¼é€»è¾‘ ---

            newGame() {
                this.clearBoard();
                const diff = parseInt(document.getElementById('difficulty').value);
                
                // 1. ç”Ÿæˆå®Œæ•´æ•°ç‹¬
                const solution = this.generateSolution();
                
                // 2. æŒ–æ´
                let puzzle = [...solution];
                let attempts = diff; 
                while (attempts > 0) {
                    let idx = Math.floor(Math.random() * 81);
                    if (puzzle[idx] !== null) {
                        puzzle[idx] = null;
                        attempts--;
                    }
                }

                // 3. æ¸²æŸ“
                const cells = document.querySelectorAll('.cell');
                for(let i=0; i<81; i++) {
                    if(puzzle[i] !== null) {
                        this.boardData[i] = puzzle[i];
                        this.fixedMask[i] = true;
                        cells[i].innerText = puzzle[i];
                        cells[i].classList.add('fixed');
                    } else {
                        this.boardData[i] = null;
                        this.fixedMask[i] = false;
                        cells[i].innerText = '';
                    }
                }
                this.updateRemain();
            }

            checkGame() {
                // æ£€æŸ¥æ˜¯å¦å¡«æ»¡
                if(this.boardData.includes(null)) {
                    this.toast('è¿˜æœ‰ç©ºæ ¼æœªå¡«å“¦');
                    return;
                }
                // éªŒè¯é€»è¾‘
                if(this.isValidSolution(this.boardData)) {
                    this.toast('ğŸ‰ æ­å–œæˆåŠŸï¼');
                } else {
                    this.toast('âŒ ç­”æ¡ˆæœ‰è¯¯ï¼Œè¯·æ£€æŸ¥çº¢è‰²æ ‡è®°');
                    this.highlightErrors();
                }
            }

            highlightErrors() {
                const cells = document.querySelectorAll('.cell');
                // ç®€å•æ£€æŸ¥ï¼šè¡Œã€åˆ—ã€å®«æ˜¯å¦æœ‰é‡å¤
                // è¿™é‡Œä¸ºäº†ç®€åŒ–ï¼Œåªæ ‡è®°æ˜æ˜¾å†²çª
                cells.forEach(c => c.classList.remove('error'));
                
                for(let i=0; i<81; i++) {
                    if(this.fixedMask[i]) continue; // é¢˜ç›®ä¸æ ‡çº¢
                    // ä¸´æ—¶æ¸…ç©ºå½“å‰æ ¼ï¼Œæ£€æŸ¥æ”¾å…¥å½“å‰å€¼æ˜¯å¦åˆæ³•
                    let val = this.boardData[i];
                    this.boardData[i] = null;
                    if(!this.isValidMove(this.boardData, i, val)) {
                        cells[i].classList.add('error');
                    }
                    this.boardData[i] = val; // æ¢å¤
                }
            }

            // --- æ±‚è§£å™¨æ¨¡å¼é€»è¾‘ ---

            solveUserBoard() {
                // æ¸…é™¤ä¹‹å‰çš„æ±‚è§£ç»“æœï¼ˆéå›ºå®šéƒ¨åˆ†ï¼‰
                const cells = document.querySelectorAll('.cell');
                for(let i=0; i<81; i++) {
                    if(!this.fixedMask[i]) {
                        this.boardData[i] = null;
                        cells[i].innerText = '';
                        cells[i].className = 'cell'; // é‡ç½®æ ·å¼
                    }
                }

                // éªŒè¯å½“å‰è¾“å…¥æ˜¯å¦åˆæ³•
                if(!this.isValidBoard(this.boardData)) {
                    this.toast('å½“å‰è¾“å…¥çš„é¢˜ç›®æœ‰å†²çªï¼');
                    return;
                }

                // æ·±åº¦æ‹·è´å¹¶æ±‚è§£
                let boardCopy = [...this.boardData];
                if(this.solve(boardCopy)) {
                    // æ¸²æŸ“ç»“æœ
                    for(let i=0; i<81; i++) {
                        if(this.boardData[i] === null) {
                            cells[i].innerText = boardCopy[i];
                            cells[i].classList.add('solved'); // ç»¿è‰²æ ‡è®°
                            this.boardData[i] = boardCopy[i]; // æ›´æ–°æ•°æ®ä»¥ä¾¿åç»­æ“ä½œ
                        }
                    }
                    this.toast('æ±‚è§£æˆåŠŸ');
                } else {
                    this.toast('æ­¤é¢˜æ— è§£');
                }
            }

            // --- äº¤äº’é€»è¾‘ ---

            onCellClick(index, el) {
                // æ¸¸æˆæ¨¡å¼ä¸‹ï¼Œå›ºå®šæ•°å­—ä¸å¯ç‚¹
                if(this.mode === 'game' && this.fixedMask[index]) return;
                
                // é€‰ä¸­æ•ˆæœ
                document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                this.selectedCell = { index, el };

                // å¼¹å‡ºé”®ç›˜
                document.getElementById('numpadOverlay').classList.add('show');
            }

            fill(num) {
                if(!this.selectedCell) return;
                const { index, el } = this.selectedCell;

                this.boardData[index] = num;
                el.innerText = num ? num : '';
                
                // æ ·å¼å¤„ç†
                el.classList.remove('error');
                if(this.mode === 'solver') {
                    // æ±‚è§£å™¨æ¨¡å¼ï¼šå¡«å…¥çš„è§†ä¸ºé¢˜ç›®(Fixed)
                    if(num) {
                        this.fixedMask[index] = true;
                        el.classList.add('fixed');
                        el.classList.remove('solved');
                    } else {
                        this.fixedMask[index] = false;
                        el.classList.remove('fixed');
                    }
                } else {
                    // æ¸¸æˆæ¨¡å¼ï¼šå¡«å…¥çš„æ˜¯ç”¨æˆ·è¾“å…¥
                    el.classList.add('user-input');
                }

                this.updateRemain();
                this.closePad(null, true);
            }

            closePad(e, force) {
                if (force || e.target.id === 'numpadOverlay') {
                    document.getElementById('numpadOverlay').classList.remove('show');
                    if(this.selectedCell) {
                        this.selectedCell.el.classList.remove('selected');
                        this.selectedCell = null;
                    }
                }
            }

            resetBoard() {
                if(this.mode === 'game') {
                    // ä»…æ¸…é™¤ç”¨æˆ·è¾“å…¥
                    const cells = document.querySelectorAll('.cell');
                    for(let i=0; i<81; i++) {
                        if(!this.fixedMask[i]) {
                            this.boardData[i] = null;
                            cells[i].innerText = '';
                            cells[i].className = 'cell';
                        } else {
                            cells[i].className = 'cell fixed'; // ç§»é™¤å¯èƒ½çš„error
                        }
                    }
                } else {
                    // æ±‚è§£å™¨ï¼šå…¨æ¸…
                    this.clearBoard();
                }
                this.updateRemain();
            }

            clearBoard() {
                this.boardData.fill(null);
                this.fixedMask.fill(false);
                const cells = document.querySelectorAll('.cell');
                cells.forEach(c => {
                    c.innerText = '';
                    c.className = 'cell';
                });
            }

            updateRemain() {
                if(this.mode === 'game') {
                    const emptyCount = this.boardData.filter(x => x === null).length;
                    document.getElementById('remain').innerText = emptyCount;
                }
            }

            toast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg; t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 2000);
            }

            // --- æ ¸å¿ƒç®—æ³• ---

            // ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„æ•°ç‹¬ç»ˆç›˜
            generateSolution() {
                let board = Array(81).fill(null);
                this.solve(board, true); // true for random
                return board;
            }

            // å›æº¯æ±‚è§£
            solve(board, random = false) {
                for (let i = 0; i < 81; i++) {
                    if (board[i] === null) {
                        let nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                        if (random) nums.sort(() => Math.random() - 0.5);

                        for (let num of nums) {
                            if (this.isValidMove(board, i, num)) {
                                board[i] = num;
                                if (this.solve(board, random)) return true;
                                board[i] = null;
                            }
                        }
                        return false;
                    }
                }
                return true;
            }

            isValidMove(board, index, num) {
                const row = Math.floor(index / 9);
                const col = index % 9;
                
                // è¡Œæ£€
                for (let c = 0; c < 9; c++) if (board[row * 9 + c] === num) return false;
                // åˆ—æ£€
                for (let r = 0; r < 9; r++) if (board[r * 9 + col] === num) return false;
                // å®«æ£€
                const startR = Math.floor(row / 3) * 3;
                const startC = Math.floor(col / 3) * 3;
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 3; c++) {
                        if (board[(startR + r) * 9 + (startC + c)] === num) return false;
                    }
                }
                return true;
            }

            // æ£€æŸ¥æ•´ä¸ªç›˜é¢æ˜¯å¦åˆæ³•ï¼ˆç”¨äºæ±‚è§£å™¨è¾“å…¥æ£€æŸ¥ï¼‰
            isValidBoard(board) {
                for(let i=0; i<81; i++) {
                    if(board[i] !== null) {
                        let val = board[i];
                        board[i] = null; // æš‚æ—¶æ‹¿å‡ºæ¥
                        if(!this.isValidMove(board, i, val)) return false;
                        board[i] = val; // æ”¾å›å»
                    }
                }
                return true;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£ç¡®è§£ç­”
            isValidSolution(board) {
                // ç®€å•èµ·è§ï¼Œåªè¦å¡«æ»¡ä¸”æ— å†²çªå³ä¸ºæˆåŠŸ
                return this.isValidBoard(board);
            }
        }

        const app = new SudokuApp();
    </script>
</body>
</html>
