<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•°å­—åå®¹é“</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* é¡¶éƒ¨ Tab æ ·å¼ä¼˜åŒ– */
        .tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: #ededed; /* å¾®ä¿¡æµ…ç°èƒŒæ™¯ */
            padding: 4px;
            border-radius: 8px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .tab-item {
            padding: 6px 24px;
            font-size: 14px;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-item.active {
            background: #fff;
            color: var(--wechat-green);
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* æ¸¸æˆä¸»å®¹å™¨ */
        .game-container {
            width: 320px;
            height: 320px;
            background: #e6e6e6; /* æ£‹ç›˜åº•è‰² */
            border-radius: 12px;
            margin: 10px auto;
            padding: 8px;
            box-sizing: border-box;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
        }
        
        /* ç½‘æ ¼å¸ƒå±€æ ¸å¿ƒä¿®å¤ */
        .grid-box {
            width: 100%;
            height: 100%;
            display: grid;
            gap: 6px; /* æ ¼å­é—´è· */
        }
        
        /* é¢„å®šä¹‰ç½‘æ ¼ç»“æ„ï¼Œé˜²æ­¢åŠ è½½æ—¶é”™ä¹± */
        .grid-box.size-3 { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
        .grid-box.size-4 { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); }
        .grid-box.size-5 { grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); }

        /* æ»‘å—æ ·å¼ - å¾®ä¿¡é£æ ¼ */
        .tile {
            background: #fff;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 3px 0 #d1d1d1; /* åº•éƒ¨ç«‹ä½“é˜´å½± */
            position: relative;
            top: 0;
        }
        .tile:active {
            transform: translateY(3px); /* æŒ‰ä¸‹æ•ˆæœ */
            box-shadow: 0 0 0 #d1d1d1;
        }
        .tile.empty {
            background: transparent;
            box-shadow: none;
            cursor: default;
        }
        /* æ•°å­—é¢œè‰² */
        .tile:not(.empty) { color: var(--wechat-green); }

        /* å­—ä½“å¤§å°é€‚é… */
        .size-3 .tile { font-size: 32px; }
        .size-4 .tile { font-size: 24px; }
        .size-5 .tile { font-size: 20px; }

        .status-bar {
            display: flex;
            justify-content: space-between;
            width: 320px;
            margin: 0 auto 15px;
            color: #888;
            font-size: 14px;
        }
        .status-bar b { color: #333; font-family: monospace; font-size: 16px; }

        .info-text { margin-top: 20px; color: #999; font-size: 13px; }
    </style>
</head>
<body>
    <div class="navbar">
        <a class="nav-left" href="../index.html"><i class="icon-back"></i></a>
        <div class="nav-title">æ•°å­—åå®¹é“</div>
    </div>

    <div class="page-content">
        <!-- é˜¶ä½é€‰æ‹© -->
        <div class="tabs">
            <div class="tab-item active" onclick="game.setSize(3, this)">3 Ã— 3</div>
            <div class="tab-item" onclick="game.setSize(4, this)">4 Ã— 4</div>
            <div class="tab-item" onclick="game.setSize(5, this)">5 Ã— 5</div>
        </div>

        <div class="status-bar">
            <span>æ­¥æ•° <b id="step">0</b></span>
            <span>æ—¶é—´ <b id="time">0</b>s</span>
        </div>

        <div class="game-container">
            <!-- é»˜è®¤åŠ ä¸Š size-3 é˜²æ­¢åˆå§‹æ¸²æŸ“é”™ä¹± -->
            <div id="grid" class="grid-box size-3"></div>
        </div>

        <div class="btn-group">
            <button class="btn" onclick="game.shuffle()">é‡æ–°å¼€å§‹</button>
        </div>
        <div class="info-text">ç‚¹å‡»ç©ºç™½æ ¼å‘¨å›´çš„æ•°å­—ç§»åŠ¨ï¼Œå°†æ•°å­—æŒ‰é¡ºåºæ’åˆ—</div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        class Klotski {
            constructor() {
                this.size = 3;
                this.grid = document.getElementById('grid');
                this.stepEl = document.getElementById('step');
                this.timeEl = document.getElementById('time');
                this.timer = null;
                this.isPlaying = false;
                this.tiles = [];
                this.emptyIndex = -1;
                this.steps = 0;
                this.seconds = 0;

                // åˆå§‹åŒ–
                this.init();
            }

            setSize(n, tabEl) {
                if(n === this.size && tabEl.classList.contains('active')) return;

                this.size = n;
                // æ›´æ–°Tab UI
                document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
                if(tabEl) tabEl.classList.add('active');
                
                // æ›´æ–° Grid Class (å…³é”®ä¿®å¤ï¼šç›´æ¥åˆ‡æ¢CSSç±»å)
                this.grid.className = `grid-box size-${n}`;
                
                this.init();
            }

            init() {
                this.resetData();
                // ç”Ÿæˆæœ‰åºæ•°ç»„
                this.tiles = Array.from({length: this.size * this.size}, (_, i) => i + 1);
                this.tiles[this.tiles.length - 1] = 0; // æœ€åä¸€ä¸ªæ˜¯ç©º
                
                this.shuffle();
            }

            resetData() {
                this.steps = 0;
                this.seconds = 0;
                this.stepEl.innerText = '0';
                this.timeEl.innerText = '0';
                clearInterval(this.timer);
                this.isPlaying = false;
            }

            startTimer() {
                if (this.isPlaying) return;
                this.isPlaying = true;
                this.timer = setInterval(() => {
                    this.seconds++;
                    this.timeEl.innerText = this.seconds;
                }, 1000);
            }

            shuffle() {
                this.resetData();
                // æ¨¡æ‹Ÿéšæœºç§»åŠ¨æ¥æ‰“ä¹±ï¼Œä¿è¯ä¸€å®šæœ‰è§£
                let count = 150 * this.size; // å¢åŠ æ‰“ä¹±æ¬¡æ•°
                
                // å…ˆé‡ç½®ä¸ºæœ‰åºçŠ¶æ€
                this.tiles = Array.from({length: this.size * this.size}, (_, i) => i + 1);
                this.tiles[this.tiles.length - 1] = 0;
                this.emptyIndex = this.tiles.length - 1;

                // å¿«é€Ÿéšæœºç§»åŠ¨
                let lastIdx = -1;
                while(count > 0) {
                    const neighbors = this.getNeighbors(this.emptyIndex);
                    // å°½é‡ä¸èµ°å›å¤´è·¯
                    let validNeighbors = neighbors.filter(n => n !== lastIdx);
                    if(validNeighbors.length === 0) validNeighbors = neighbors;
                    
                    const randomIdx = validNeighbors[Math.floor(Math.random() * validNeighbors.length)];
                    
                    // äº¤æ¢
                    [this.tiles[this.emptyIndex], this.tiles[randomIdx]] = [this.tiles[randomIdx], this.tiles[this.emptyIndex]];
                    lastIdx = this.emptyIndex;
                    this.emptyIndex = randomIdx;
                    count--;
                }
                this.render();
            }

            getNeighbors(idx) {
                const s = this.size;
                const row = Math.floor(idx / s);
                const col = idx % s;
                const neighbors = [];
                
                if (row > 0) neighbors.push(idx - s); // ä¸Š
                if (row < s - 1) neighbors.push(idx + s); // ä¸‹
                if (col > 0) neighbors.push(idx - 1); // å·¦
                if (col < s - 1) neighbors.push(idx + 1); // å³
                
                return neighbors;
            }

            move(idx) {
                const neighbors = this.getNeighbors(this.emptyIndex);
                if (neighbors.includes(idx)) {
                    if (!this.isPlaying) this.startTimer();
                    
                    // äº¤æ¢
                    [this.tiles[this.emptyIndex], this.tiles[idx]] = [this.tiles[idx], this.tiles[this.emptyIndex]];
                    this.emptyIndex = idx;
                    this.steps++;
                    this.stepEl.innerText = this.steps;
                    
                    this.render();
                    this.checkWin();
                }
            }

            render() {
                this.grid.innerHTML = '';
                this.tiles.forEach((num, index) => {
                    const div = document.createElement('div');
                    div.className = num === 0 ? 'tile empty' : 'tile';
                    if (num !== 0) {
                        div.innerText = num;
                        div.onclick = () => this.move(index);
                    }
                    this.grid.appendChild(div);
                });
            }

            checkWin() {
                for (let i = 0; i < this.tiles.length - 1; i++) {
                    if (this.tiles[i] !== i + 1) return;
                }
                
                clearInterval(this.timer);
                this.isPlaying = false;
                setTimeout(() => {
                    const t = document.getElementById('toast');
                    t.innerText = `ğŸ‰ æŒ‘æˆ˜æˆåŠŸï¼\n${this.size}é˜¶è€—æ—¶ ${this.seconds}ç§’`;
                    t.classList.add('show');
                    setTimeout(()=>t.classList.remove('show'), 3000);
                }, 200);
            }
        }

        const game = new Klotski();
    </script>
</body>
</html>
