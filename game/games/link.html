<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿è¿æ¶ˆé™¤</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        /* 6x6 ç½‘æ ¼ */
        .grid-link { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 6px; 
            width: 100%; 
            max-width: 340px; 
            margin: 20px auto;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .cell-link { 
            aspect-ratio: 1; 
            background: white; 
            border-radius: 6px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 28px; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.1s, background 0.2s;
            user-select: none;
        }
        .cell-link:active { transform: scale(0.95); }
        .cell-link.selected { 
            background: #e6f7ff; 
            border: 2px solid var(--wechat-green); 
            box-sizing: border-box;
        }
        /* æ¶ˆé™¤åçš„çŠ¶æ€ */
        .cell-link.empty { 
            visibility: hidden; 
            pointer-events: none; 
        }
        /* è¿æ¥çº¿é«˜äº® (å¯é€‰ï¼Œç®€å•ç‰ˆç”¨é—ªçƒä»£æ›¿) */
        .cell-link.matched {
            background: #95ec69;
            transition: background 0.2s;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a class="nav-left" href="../index.html"><i class="icon-back"></i></a>
        <div class="nav-title">è¿è¿æ¶ˆé™¤</div>
    </div>

    <div class="page-content">
        <div class="info-text">å‰©ä½™æ–¹å—: <span id="remain">36</span></div>
        
        <div id="grid" class="grid-link"></div>
        
        <div class="btn-group">
            <button class="btn btn-sec" onclick="game.shuffle()">ğŸ”„ æ´—ç‰Œ</button>
            <button class="btn" onclick="game.init()">é‡ç½®æ¸¸æˆ</button>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        class LinkGame {
            constructor() {
                this.rows = 6;
                this.cols = 6;
                this.icons = ['ğŸ', 'ğŸ‡', 'ğŸ‰', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ', 'ğŸ¥', 'ğŸ¥‘']; // 9ç§å›¾æ ‡
                this.init();
            }

            init() {
                this.board = []; // å­˜å‚¨å›¾æ ‡ç´¢å¼•
                this.selected = null; // å½“å‰é€‰ä¸­çš„ {r, c, el}
                this.remain = this.rows * this.cols;
                
                // ç”Ÿæˆæˆå¯¹æ•°æ®
                let pairs = [];
                let totalPairs = (this.rows * this.cols) / 2;
                for (let i = 0; i < totalPairs; i++) {
                    let icon = this.icons[i % this.icons.length];
                    pairs.push(icon, icon);
                }
                // æ‰“ä¹±
                pairs.sort(() => Math.random() - 0.5);
                
                // å¡«å……äºŒç»´æ•°ç»„
                for(let r=0; r<this.rows; r++) {
                    this.board[r] = [];
                    for(let c=0; c<this.cols; c++) {
                        this.board[r][c] = pairs.pop();
                    }
                }
                
                this.render();
                this.updateUI();
            }

            render() {
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                for(let r=0; r<this.rows; r++) {
                    for(let c=0; c<this.cols; c++) {
                        let div = document.createElement('div');
                        div.className = 'cell-link';
                        div.innerText = this.board[r][c];
                        div.dataset.r = r;
                        div.dataset.c = c;
                        div.onclick = (e) => this.click(r, c, e.target);
                        grid.appendChild(div);
                    }
                }
            }

            // æ´—ç‰Œï¼ˆåªæ´—å‰©ä¸‹çš„ï¼‰
            shuffle() {
                let currentItems = [];
                // æ”¶é›†
                for(let r=0; r<this.rows; r++) {
                    for(let c=0; c<this.cols; c++) {
                        if(this.board[r][c]) currentItems.push(this.board[r][c]);
                    }
                }
                if(currentItems.length === 0) return;
                
                currentItems.sort(() => Math.random() - 0.5);
                
                // æ”¾å›
                const cells = document.querySelectorAll('.cell-link');
                let idx = 0;
                for(let r=0; r<this.rows; r++) {
                    for(let c=0; c<this.cols; c++) {
                        if(this.board[r][c]) {
                            this.board[r][c] = currentItems[idx];
                            // æ›´æ–°DOM
                            let cell = cells[r*this.cols + c];
                            cell.innerText = currentItems[idx];
                            cell.classList.remove('selected');
                            idx++;
                        }
                    }
                }
                this.selected = null;
                this.toast('å·²é‡æ–°æ´—ç‰Œ');
            }

            click(r, c, el) {
                if(!this.board[r][c]) return; // ç‚¹å‡»äº†ç©ºçš„
                if(this.selected && this.selected.r === r && this.selected.c === c) {
                    // å–æ¶ˆé€‰ä¸­
                    el.classList.remove('selected');
                    this.selected = null;
                    return;
                }

                el.classList.add('selected');

                if(!this.selected) {
                    // ç¬¬ä¸€ä¸ªé€‰ä¸­
                    this.selected = {r, c, el};
                } else {
                    // ç¬¬äºŒä¸ªé€‰ä¸­ï¼Œåˆ¤æ–­æ¶ˆé™¤
                    if(this.board[r][c] === this.board[this.selected.r][this.selected.c]) {
                        // å›¾æ ‡ç›¸åŒï¼Œæ£€æŸ¥è·¯å¾„
                        if(this.checkPath(this.selected.r, this.selected.c, r, c)) {
                            this.match(this.selected, {r, c, el});
                        } else {
                            // è·¯å¾„ä¸é€šï¼Œåˆ‡æ¢é€‰ä¸­
                            this.selected.el.classList.remove('selected');
                            this.selected = {r, c, el};
                        }
                    } else {
                        // å›¾æ ‡ä¸åŒï¼Œåˆ‡æ¢é€‰ä¸­
                        this.selected.el.classList.remove('selected');
                        this.selected = {r, c, el};
                    }
                }
            }

            match(p1, p2) {
                // è§†è§‰æ•ˆæœ
                p1.el.classList.add('matched');
                p2.el.classList.add('matched');
                p1.el.classList.remove('selected');
                p2.el.classList.remove('selected');

                setTimeout(() => {
                    // é€»è¾‘æ¶ˆé™¤
                    this.board[p1.r][p1.c] = null;
                    this.board[p2.r][p2.c] = null;
                    // DOMæ¶ˆé™¤
                    p1.el.classList.add('empty');
                    p1.el.classList.remove('matched');
                    p1.el.innerText = '';
                    p2.el.classList.add('empty');
                    p2.el.classList.remove('matched');
                    p2.el.innerText = '';
                    
                    this.selected = null;
                    this.remain -= 2;
                    this.updateUI();
                    
                    if(this.remain === 0) {
                        this.toast('æ­å–œé€šå…³ï¼');
                    }
                }, 200);
            }

            updateUI() {
                document.getElementById('remain').innerText = this.remain;
            }

            // --- æ ¸å¿ƒç®—æ³•ï¼šè·¯å¾„æ£€æµ‹ ---
            // 0æŠ˜(ç›´çº¿), 1æŠ˜(1ä¸ªè§’), 2æŠ˜(2ä¸ªè§’)
            checkPath(r1, c1, r2, c2) {
                if (r1 === r2 && c1 === c2) return false;
                
                // 1. ç›´è¿æ£€æµ‹
                if (this.isLineEmpty(r1, c1, r2, c2)) return true;

                // 2. ä¸€æŠ˜æ£€æµ‹ (æ‰¾ä¸€ä¸ªæ‹ç‚¹Cï¼Œä½¿å¾— A-C å’Œ C-B éƒ½æ˜¯é€šè·¯)
                // æ‹ç‚¹å¿…é¡»æ˜¯ç©ºçš„(æˆ–è€…å°±æ˜¯ç›®æ ‡ç‚¹ï¼Œä½†è¿™é‡Œç›®æ ‡ç‚¹è‚¯å®šæœ‰ä¸œè¥¿ï¼Œæ‰€ä»¥æ‹ç‚¹å¿…é¡»æ˜¯ç©º)
                // æ‹ç‚¹åªæœ‰ä¸¤ä¸ªå¯èƒ½: (r1, c2) å’Œ (r2, c1)
                if (this.isEmpty(r1, c2) && this.isLineEmpty(r1, c1, r1, c2) && this.isLineEmpty(r1, c2, r2, c2)) return true;
                if (this.isEmpty(r2, c1) && this.isLineEmpty(r1, c1, r2, c1) && this.isLineEmpty(r2, c1, r2, c2)) return true;

                // 3. ä¸¤æŠ˜æ£€æµ‹ (æ‰«æçº¿æ³•)
                // åœ¨æ°´å¹³æ–¹å‘æˆ–å‚ç›´æ–¹å‘å¯»æ‰¾ä¸€ä¸ªä¸­é—´ç‚¹Pï¼Œä½¿å¾— A-P ç›´è¿ï¼Œä¸” P-B æ˜¯ä¸€æŠ˜è¿æ¥
                
                // æ‰«ææ‰€æœ‰è¡Œ
                for (let i = 0; i < this.rows; i++) {
                    // å¯»æ‰¾å…³é”®ç‚¹ (i, c1) å’Œ (i, c2)
                    // é€»è¾‘ï¼šä» A(r1,c1) èµ°åˆ° (i,c1)ï¼Œå†æŠ˜åˆ° (i,c2)ï¼Œå†æŠ˜åˆ° B(r2,c2)
                    // å¿…é¡»æ»¡è¶³ï¼š(i,c1)ç©º, (i,c2)ç©º, ä¸‰æ®µè·¯éƒ½é€š
                    // ä¼˜åŒ–ï¼šå…¶å®å°±æ˜¯åˆ¤æ–­ (i, c1) å’Œ (i, c2) æ„æˆçš„Uå‹é€šè·¯
                    if (this.isEmpty(i, c1) && this.isEmpty(i, c2) && 
                        this.isLineEmpty(r1, c1, i, c1) && // ç«–
                        this.isLineEmpty(i, c1, i, c2) && // æ¨ª
                        this.isLineEmpty(i, c2, r2, c2))  // ç«–
                    {
                        return true;
                    }
                }
                
                // æ‰«ææ‰€æœ‰åˆ—
                for (let j = 0; j < this.cols; j++) {
                    if (this.isEmpty(r1, j) && this.isEmpty(r2, j) &&
                        this.isLineEmpty(r1, c1, r1, j) && // æ¨ª
                        this.isLineEmpty(r1, j, r2, j) && // ç«–
                        this.isLineEmpty(r2, j, r2, c2))  // æ¨ª
                    {
                        return true;
                    }
                }

                return false;
            }

            // åˆ¤æ–­ç‚¹æ˜¯å¦ä¸ºç©º (æˆ–è€…è¶Šç•Œè§†ä¸ºä¸é€šï¼Œä½†åœ¨æœ¬ç®€æ˜“ç‰ˆä¸­ä¸å¤„ç†è¶Šç•Œè¿çº¿)
            isEmpty(r, c) {
                return this.board[r][c] === null;
            }

            // åˆ¤æ–­ç›´çº¿æ˜¯å¦ç•…é€š (ä¸åŒ…å«èµ·ç‚¹å’Œç»ˆç‚¹æœ¬èº«çš„å†…å®¹åˆ¤æ–­)
            isLineEmpty(r1, c1, r2, c2) {
                if (r1 === r2) { // åŒè¡Œ
                    let min = Math.min(c1, c2);
                    let max = Math.max(c1, c2);
                    for (let c = min + 1; c < max; c++) {
                        if (this.board[r1][c] !== null) return false;
                    }
                    return true;
                } else if (c1 === c2) { // åŒåˆ—
                    let min = Math.min(r1, r2);
                    let max = Math.max(r1, r2);
                    for (let r = min + 1; r < max; r++) {
                        if (this.board[r][c1] !== null) return false;
                    }
                    return true;
                }
                return false;
            }

            toast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg; t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 1500);
            }
        }
        const game = new LinkGame();
    </script>
</body>
</html>
